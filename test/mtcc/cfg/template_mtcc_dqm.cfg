process ReadRUFile = {

service = MessageLogger {
	untracked vstring destinations = { "insert_logpath/event_dqm_insert_outputfilename.log", "insert_logpath/error_dqm_insert_outputfilename.log", "insert_logpath/debug_dqm_insert_outputfilename.log" }
	untracked PSet error_dqm_insert_outputfilename.log = { string threshold = "ERROR" PSet default = { int32 limit = -1 bool noLineBreaks = false } }
	untracked PSet event_dqm_insert_outputfilename.log = { string threshold = "INFO"    PSet default = { int32 limit = -1 bool noLineBreaks = false } }
	untracked PSet debug_dqm_insert_outputfilename.log = { string threshold = "DEBUG"   PSet default = { int32 limit = -1 bool noLineBreaks = false } }
#	vstring debugModules = { "*" } //@@ uncomment this line for debug statements!
}

#service = Tracer {}
#service = Timing { }

#Geometry
include "Geometry/CMSCommonData/data/cmsMTCCGeometryXML.cfi"

es_module = TrackerGeometricDetESModule {}
es_module = TrackerDigiGeometryESModule {}

#Magnetic Field
#
include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"

es_source = PoolDBESSource { 
              VPSet toGet = {
                { string record = "SiStripPedestalsRcd"
                  string tag = "SiStripPedestals_v1"
                }
               ,{ string record = "SiStripNoisesRcd"
                  string tag = "SiStripNoises_v1"
                } 
              }
              bool loadAll = true
              string connect = "sqlite_file:insert_SiStripPedNoisesDB"
	      untracked string catalog = "file:insert_SiStripPedNoisesCatalog" 
              string timetype = "runnumber" 
	      untracked uint32 authenticationMethod = 0
              untracked uint32 messagelevel = 0
            }

es_source = SiStripFedCablingFromXml {
	string Label="Fed1"
	string XmlParsedFile="insert_fedconnection_description"
}

source = TBRUInputSource
{
	untracked vstring fileNames = { insert_input_filenames }
	untracked int32 maxEvents = -1 //@@ all events
	#untracked int32 nFeds = 1 # not strictly necessary
}

module RawToDigi = SiStripRawToDigiModule 
{
	string InputModuleLabel = "TBRUInputSource"
	untracked int32 AppendedBytes = 0
       	untracked int32 FedBufferDumpFreq = 0
       	untracked bool  UseFedKey = false
       	untracked int32 TriggerFedId = 1023
}

module  theSiStripZeroSuppression =  SiStripZeroSuppression {
	string RawDigiProducer = "RawToDigi"

	string ZeroSuppressionMode  = "SiStripFedZeroSuppression"
	uint32 FEDalgorithm  = 4
	string CommonModeNoiseSubtractionMode = "Median"

        bool UseCalibDataFromDB    = true
	untracked string userEnv   = "me"
	untracked string passwdEnv = "me"

        double ElectronPerAdc      = 313.0 
	double EquivalentNoiseCharge300um = 2160.
	double BadStripProbability = 0.002
	uint32  PedestalValue	   = 30
	double  LowThValue         =  2
	double  HighThValue        =  5
}

module ThreeThresholdClusterizer =  SiStripClusterizer {
    untracked int32 VerbosityLevel = 0

           VPSet DigiProducersList = {
#                { string DigiProducer = "stripdigi"
#                  string DigiLabel    = "\0"
#                },
                { string DigiProducer = "RawToDigi"
                  string DigiLabel    = "ZeroSuppressed"
                },
                { string DigiProducer = "theSiStripZeroSuppression"
                  string DigiLabel    = "fromVirginRaw"
                },
                { string DigiProducer = "theSiStripZeroSuppression"
                  string DigiLabel    = "fromProcessedRaw"
                },
                { string DigiProducer = "theSiStripZeroSuppression"
                  string DigiLabel    = "fromScopeMode"
                }
              }	
	untracked string userEnv   = "me"
	untracked string passwdEnv = "me"
           bool UseCalibDataFromDB = true

	string ClusterMode         = "ThreeThresholdClusterizer"
	double ChannelThreshold    = 2.0
	double SeedThreshold       = 3.0
	double ClusterThreshold    = 5.0
	 int32 MaxHolesInCluster   = 0	

        double ElectronPerAdc      = 313.0 
	double EquivalentNoiseCharge300um = 2160.
	double BadStripProbability = 0.0
}


include "RecoLocalTracker/SiStripRecHitConverter/data/StripCPEfromTrackAngle.cfi"
include "RecoLocalTracker/SiStripRecHitConverter/data/SiStripRecHitConverter.cfi"

// -- DQM --------------------------------------------------------------------------------

//// can comment out MonitorDeamon if you want to run without DQMCollector
//       service = MonitorDaemon{
//       # if true, will automatically start DQM thread in background
//       untracked bool AutoInstantiate=true
//       # if >=0, upon a connection problem, the source will automatically
//       # attempt to reconnect with a time delay (secs) specified here
//       # (default: 5)
//       untracked int32 reconnect_delay = 5
//       # collector hostname; examples: localhost(default),lxcmse2.cern.ch, etc
//       untracked string DestinationAddress = "localhost"
//       # port for communicating with collector (default: 9090)
//       untracked int32 SendPort = 9090
//       # monitoring period in ms (i.e. how often monitoring elements
//       # are shipped to the collector; default: 1000)
//       untracked int32 UpdateDelay = 1000
//       # name of DQM source (default: DQMSource)
//       untracked string NameAsSource = "FU0"
//       }


// produce SiStripFecCabling and SiStripDetCabling out of SiStripFedCabling
       es_module sistripconn = SiStripConnectivity {}
       service = DaqMonitorROOTBackEnd{}

       module digimonitor = SiStripMonitorDigi {
                               // simulated digis
#                               string DigiProducer="theSiStripZeroSuppression"
#                               string DigiLabel="fromVirginRaw"

                              // add digi producers a la Domenico
                                VPSet DigiProducersList = {
#                                     { string DigiProducer = "stripdigi"
#                                       string DigiLabel    = "\0"
#                                     },
                                     { string DigiProducer = "RawToDigi"
                                       string DigiLabel    = "ZeroSuppressed"
                                     },
                                     { string DigiProducer = "theSiStripZeroSuppression"
                                       string DigiLabel    = "fromVirginRaw"
                                     },
                                     { string DigiProducer = "theSiStripZeroSuppression"
                                       string DigiLabel    = "fromProcessedRaw"
                                     },
                                     { string DigiProducer = "theSiStripZeroSuppression"
                                       string DigiLabel    = "fromScopeMode"
                                     }
                                   }

                               // rest of parameters
                               bool ShowMechanicalStructureView = true
                               bool ShowReadoutView = false
                               bool ShowControlView = false
                               bool OutputMEsInRootFile = false
                               string OutputFileName="test_digi.root"
                            }

       module clustermonitor = SiStripMonitorCluster {
                               string ClusterProducer="ThreeThresholdClusterizer"
                               string ClusterLabel=""
                               //
                               bool ShowMechanicalStructureView = true
                               bool ShowReadoutView = false
                               bool ShowControlView = false
                               bool OutputMEsInRootFile = true
                               string OutputFileName="insert_outputpath/insert_dqmhistos_file.root"
                               }
// -- DQM --------------------------------------------------------------------------------

module PoolOutput = PoolOutputModule 
{ 
	untracked string fileName = "insert_outputpath/insert_outputfilename.root" 
	#untracked vstring outputCommands = { "keep *" } //@@ necessary?
}

path p = { 
		RawToDigi, 
		theSiStripZeroSuppression,
		ThreeThresholdClusterizer,
                digimonitor,
                clustermonitor,
		LocalMeasurementConverter
	 }

#endpath e = { PoolOutput}

}

